{"version":3,"file":"Mailbox-3b0da227.js","sources":["../../node_modules/svelte-material-icons/StarOutline.svelte","../../node_modules/svelte-material-icons/Star.svelte","../../node_modules/svelte-material-icons/CheckboxBlankOutline.svelte","../../node_modules/svelte-material-icons/CheckboxMarked.svelte","../../src/lib/formatter.js","../../src/comp/Pages/Mailbox/MailboxMessage.svelte","../../node_modules/svelte-material-icons/Refresh.svelte","../../node_modules/svelte-material-icons/CheckboxIntermediate.svelte","../../node_modules/svelte-material-icons/Check.svelte","../../node_modules/svelte-material-icons/Plus.svelte","../../src/comp/Pages/Mailbox/Mailbox.svelte","../../src/lib/router/routes/Mailbox.svelte","../../src/lib/selection.js"],"sourcesContent":["<script>\n  export let size = \"1em\";\n  export let width = size;\n  export let height = size;\n  export let color = \"currentColor\";\n  export let viewBox = \"0 0 24 24\";\n</script>\n\n<svg width=\"{width}\" height=\"{height}\" viewBox=\"{viewBox}\"><path d=\"M12,15.39L8.24,17.66L9.23,13.38L5.91,10.5L10.29,10.13L12,6.09L13.71,10.13L18.09,10.5L14.77,13.38L15.76,17.66M22,9.24L14.81,8.63L12,2L9.19,8.63L2,9.24L7.45,13.97L5.82,21L12,17.27L18.18,21L16.54,13.97L22,9.24Z\" fill=\"{color}\"/></svg>","<script>\n  export let size = \"1em\";\n  export let width = size;\n  export let height = size;\n  export let color = \"currentColor\";\n  export let viewBox = \"0 0 24 24\";\n</script>\n\n<svg width=\"{width}\" height=\"{height}\" viewBox=\"{viewBox}\"><path d=\"M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z\" fill=\"{color}\"/></svg>","<script>\n  export let size = \"1em\";\n  export let width = size;\n  export let height = size;\n  export let color = \"currentColor\";\n  export let viewBox = \"0 0 24 24\";\n</script>\n\n<svg width=\"{width}\" height=\"{height}\" viewBox=\"{viewBox}\"><path d=\"M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V19H5V5H19Z\" fill=\"{color}\"/></svg>","<script>\n  export let size = \"1em\";\n  export let width = size;\n  export let height = size;\n  export let color = \"currentColor\";\n  export let viewBox = \"0 0 24 24\";\n</script>\n\n<svg width=\"{width}\" height=\"{height}\" viewBox=\"{viewBox}\"><path d=\"M10,17L5,12L6.41,10.58L10,14.17L17.59,6.58L19,8M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3Z\" fill=\"{color}\"/></svg>","//const months = [\"ene\", \"feb\", \"mar\", \"abr\", \"may\", \"jun\", \"jul\", \"ago\", \"sep\", \"oct\", \"nov\", \"dic\"]\n//const days = [\"dom\", \"lun\", \"mar\", \"mie\", \"jue\", \"vie\", \"sab\"]\nconst pad = (n) => n.toString().padStart(2, \"0\");\nexport const date = (str, locale) => {\n    const now = new Date();\n    const date = new Date(str);\n    if (now.getFullYear() !== date.getFullYear())\n        return `${locale.months[date.getMonth()]} ${date.getFullYear()}`;\n    if (now.getMonth() !== date.getMonth())\n        return `${date.getDate()} ${locale.months[date.getMonth()]}`;\n    if (now.getDate() !== date.getDate()) {\n        return `${locale.weekDays[date.getDay()]} ${date.getDate()}`;\n    }\n    return `${date.getHours()}:${pad(date.getMinutes())}`;\n};\n","<style>\n  .message {\n    font: inherit;\n    text-decoration: none;\n    flex: none;\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    border-top:#d8dcdf 1px solid;\n    padding: 0.25em 1em;\n  }\n\n  .show-hover {\n    display: none !important;\n  }\n\n  .message:hover .show-hover {\n    display: flex !important;\n  }\n\n  .message:hover .hide-hover {\n    display: none;\n  }\n\n\n\n  .message:last-of-type {\n    border-bottom: #d8dcdf 1px solid;\n  }\n  \n  .message:last-of-type.selected {\n    border-bottom-color: #a5bad9;\n  }\n\n  .message:first-child {\n    border-top: none;\n  }\n  \n  .selected {\n    background-color: #c2dbff;\n    border-bottom-color: #a5bad9; \n    border-top-color: #a5bad9; \n  }\n\n  .selected + .message {\n    border-top-color: #a5bad9;\n  }\n\n  x-cell {\n    flex: 1;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n\n  .icon {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    flex: none;\n    width: 2em;\n    height: 2em;\n    font-size: 1.25em;\n    cursor: pointer;\n    border-radius: 50%;\n    transition: color 200ms ease;\n  }\n\n  .icon > :global(svg) {\n    position: absolute;\n  }\n\n  .flagged {\n    color: #e3c066;\n  }\n  \n  .from {\n    padding: 0 1em;\n    flex: 2;\n  }\n\n  .subject-intro {\n    flex: 6;\n  }\n\n  .intro {\n    opacity: 0.5;\n    margin-inline-start: 0.5em;\n  }\n\n  .date {\n    text-align: end;\n    opacity: 0.5;\n    /*text-transform: capitalize;*/\n    flex: none;\n    margin-inline-start: 1em;\n    font-size: 0.8em;\n  }\n\n  .unseen {\n    font-weight: 700;\n  }\n\n  .from-subject-date {\n    flex: 1;\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n  }\n\n  @media screen and (max-width: 700px) {\n\n    .message {\n      padding-inline-start: 0.45em;\n    }\n\n    .cell-selected {\n      margin-inline-end: -0.45em;\n    }\n\n    .from-subject-date {\n      flex-direction: column;\n      overflow: hidden;\n      margin-inline-start: 0.5em;\n      padding-top: 0.25em;\n      padding-bottom: 0.25em;\n    }\n\n   .from-subject-date > x-cell{\n      padding: 0;\n    }\n\n    .from-subject-date > x-cell + x-cell{\n      margin-top: 0.35em;\n    }\n\n    .from {\n      align-self: flex-start;\n      margin: 0;\n    }\n\n    .subject-intro {\n      align-self: flex-start;\n      flex: none;\n      width: 100%;\n    }\n\n    .date {\n      align-self: flex-start;\n      margin: 0;\n    }\n  }\n</style>\n\n<script>\n  import {writable} from \"lib@store.js\";\n  import {slide, fly} from \"svelte/transition\";\n\n  import UnFlagged from \"svelte-material-icons/StarOutline.svelte\";\n  import Flagged from \"svelte-material-icons/Star.svelte\";\n\n  import On from \"svelte-material-icons/CheckboxBlankOutline.svelte\";\n  import Off from \"svelte-material-icons/CheckboxMarked.svelte\";\n\n  import {Ripple} from \"svelte-mui\";\n\n  import {getContext, onDestroy} from \"svelte\";\n  const selection = getContext(\"mailbox-selection\");\n  const {isSelected, add, remove, toggle} = selection;\n\n  import {create} from \"comp@Compose/compose.js\";\n\n  import {drafts, sent} from \"lib@client/mailboxes.js\";\n  import * as mess from \"lib@client/messages.js\";\n\n  export let message;\n  export let mailbox;\n\n  let isDraft, isSent, selected;\n  $: isDraft = mailbox === drafts;\n  $: isSent = mailbox === sent;\n  $: selected = $isSelected(message);\n\n  const flag = e => {\n    mess.flag($mailbox.id, [$message.id], !$message.flagged);\n    message.update(m => ({...m, flagged: !m.flagged}))\n  }\n\n  let unsub;\n\n  const click = async e => {\n    if (isDraft) {\n      e.preventDefault();\n      if ( !$message.seen ) {\n        //mess.updateSeen($mailbox.id, [$message.id], true)\n        message.update(m => ({...m, seen: true}));\n      }\n      \n      const $draft = await mess.getDraft($message.id);\n      const draft = writable($draft);\n      unsub = draft.subscribe(d => {\n        message.update(m => ({...m, ...d}))\n      })\n      \n      create(draft)\n    }\n  }\n\n  onDestroy(() => unsub && unsub())\n\n  import {date} from \"lib@formatter.js\";\n\n  const {locale: l} = getContext(\"app\");\n  export let locale = $l;\n</script>\n\n<a href=\"#!/mailbox/{$mailbox.id}/message/{$message.id}\" class=\"na message\" class:selected class:unseen={!$message.seen} on:click={click}>\n  <x-cell class=\"btn-dark icon cell-selected\" on:click|preventDefault|stopPropagation={() => toggle(message)}>\n    {#if selected}\n      <Off />\n    {:else}\n      <On />\n    {/if}\n    <Ripple />\n  </x-cell>\n\n\n  <x-cell class=\"btn-dark icon\" class:flagged={$message.flagged} on:click|preventDefault|stopPropagation={flag}>\n    {#if $message.flagged}\n      <Flagged />\n    {:else}\n      <UnFlagged />\n    {/if}\n    <Ripple />\n  </x-cell>\n\n  <x-cell-group class=\"from-subject-date\">\n    <x-cell class=\"from\">\n      {#if isSent || isDraft}\n        <span class=\"for\">{locale.mailboxMessage.to} </span>{($message.to || []).map(to => to.name || to.address).filter(Boolean).join(\", \")}\n      {:else}\n        {$message.from.name || $message.from.address || \"\"}\n      {/if}\n    </x-cell>\n\n\n    <x-cell class=\"subject-intro\">\n      <span class=\"subject\">{$message.subject || \"\"}</span>\n      <span class=\"intro\">{$message.intro || \"\"}</span>\n    </x-cell>\n\n\n    <x-cell class=\"date\">\n      {$message.date && date($message.date, locale)}\n    </x-cell>\n  </x-cell-group>\n</a>","<script>\n  export let size = \"1em\";\n  export let width = size;\n  export let height = size;\n  export let color = \"currentColor\";\n  export let viewBox = \"0 0 24 24\";\n</script>\n\n<svg width=\"{width}\" height=\"{height}\" viewBox=\"{viewBox}\"><path d=\"M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z\" fill=\"{color}\"/></svg>","<script>\n  export let size = \"1em\";\n  export let width = size;\n  export let height = size;\n  export let color = \"currentColor\";\n  export let viewBox = \"0 0 24 24\";\n</script>\n\n<svg width=\"{width}\" height=\"{height}\" viewBox=\"{viewBox}\"><path d=\"M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V5H19V19M17,17H7V7H17V17Z\" fill=\"{color}\"/></svg>","<script>\n  export let size = \"1em\";\n  export let width = size;\n  export let height = size;\n  export let color = \"currentColor\";\n  export let viewBox = \"0 0 24 24\";\n</script>\n\n<svg width=\"{width}\" height=\"{height}\" viewBox=\"{viewBox}\"><path d=\"M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z\" fill=\"{color}\"/></svg>","<script>\n  export let size = \"1em\";\n  export let width = size;\n  export let height = size;\n  export let color = \"currentColor\";\n  export let viewBox = \"0 0 24 24\";\n</script>\n\n<svg width=\"{width}\" height=\"{height}\" viewBox=\"{viewBox}\"><path d=\"M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z\" fill=\"{color}\"/></svg>","<script>\n  import {getContext, setContext, onMount} from \"svelte\";\n  import {fade} from \"svelte/transition\";\n\n  import {writable} from \"../../../lib/store\";\n\n  import Item from \"./MailboxMessage.svelte\";\n  import Tab from \"../Main.svelte\";\n  import Topbar from \"../ActionBar.svelte\";\n\n  //import EmptyFolder from \"svelte-material-icons/FolderOpenOutline.svelte\";\n\n  import Refresh from \"svelte-material-icons/Refresh.svelte\";\n  import Delete from \"svelte-material-icons/DeleteOutline.svelte\";\n  import MarkUnSeen from \"svelte-material-icons/EmailOutline.svelte\";\n  import MarkSeen from \"svelte-material-icons/EmailOpenOutline.svelte\";\n  import MarkSpam from \"svelte-material-icons/AlertDecagramOutline.svelte\";\n  import UnMarkSpam from \"svelte-material-icons/EmailCheckOutline.svelte\";\n  import CheckAll from \"svelte-material-icons/CheckboxMarked.svelte\";\n  import CheckNone from \"svelte-material-icons/CheckboxBlankOutline.svelte\";\n  import CheckSome from \"svelte-material-icons/CheckboxIntermediate.svelte\";\n\n  import CheckCircle from \"svelte-material-icons/CheckCircle.svelte\";\n  import Check from \"svelte-material-icons/Check.svelte\";\n\n  import More from \"svelte-material-icons/Plus.svelte\";\n  import CircularProgress from \"../../CircularProgress.svelte\";\n\n  import {Ripple} from \"svelte-mui\";\n  import MoveTo from \"../MoveTo.svelte\";\n\n  export let mailbox;\n  export let messages;\n  export let next;\n  export let prev;\n  export let selection;\n  export let scroll;\n\n  setContext(\"mailbox-selection\", selection);\n\n  import {junk, trash, drafts, sent} from \"../../../lib/client/mailboxes\";\n  import * as mess from \"../../../lib/client/messages\";\n\n  let isJunk, isTrash, isDraft, isSent;\n  $: isJunk = mailbox === junk;\n  $: isTrash = mailbox === trash;\n  $: isDraft = mailbox === drafts;\n  $: isSent = mailbox === sent;\n\n  const handleSelection = () => {\n    selection.update($sel => {\n      if($selection.length !== $messages.length) {\n        return $messages.slice();\n      } else {\n        return [];\n      }\n    })\n  }\n\n  const onSelectionMoved = () => {\n    const selected = selection.get();\n    messages.update(ms => ms.filter(m => !selected.includes(m)));\n    selection.clear();\n    if(messages.get().length < 10) {\n      loadMore();\n    }\n  } \n  \n\n  const updateSeen = async (seen) => {\n    if($selection.length) {\n      $selection.forEach(m => m.update(m => ({...m, seen})))\n      selection.invalidate();\n      await mess.updateSeen($mailbox.id, $selection.map(i => i.get().id), seen)\n    }\n  }\n\n  const markAsSpam = async (value) => {\n    mess.markAsSpam($mailbox.id, $selection.map(i => i.get().id), value);\n    onSelectionMoved();\n  }\n\n  const del = async () => {\n    mess.del($mailbox.id, $selection.map(i => i.get().id));\n    onSelectionMoved();\n  }\n\n  import {list} from \"lib@client/messages.js\";\n  \n  let reloading = false;\n  let reloadTimes = 0;\n  const reload = async () => {\n    if (reloading)\n      return;\n    reloadTimes++;\n    reloading = true;\n    const json = await list($mailbox.id);\n    messages.set(json.messages.map(m => writable(m)))\n    prev.set(json.prev);\n    next.set(json.next);\n    selection.clear();\n    reloading = false;\n  }\n\n  let loadingMore = false;\n  const loadMore = async () => {\n    if ( !$next )\n      return;\n    \n    loadingMore = true;\n    const res = await mess.next($mailbox.id, $next);\n    messages.update(m => [...m, ...res.messages.map(m => writable(m))])\n    next.set(res.next);\n    prev.set(res.prev);\n    loadingMore = false;\n  }\n\n  const flyInsert = (node, params) => {\n    node.classList.add(\"removed\");\n    node.style.zIndex = \"1\";\n    setTimeout(() => node.classList.remove(\"removed\"), 1);\n    setTimeout(() => node.style.zIndex = null, 150)\n    return {duration: 150}\n  }\n\n  const flyRemove = (node) => {\n    node.classList.add(\"removed\");\n    return {duration: 150}\n  }\n\n  const {locale: l, trans} = getContext(\"app\");\n  export let locale = $l;\n\n  import {mailboxMeta} from \"../../../lib/util\";\n\n  let meta;\n  $: meta = mailboxMeta($mailbox, locale.mailbox.title);\n\n  // shell: You can use this from chrome console\n  const shell = {\n    matchKeys: [ \"from\", \"subject\", \"intro\" ],\n    sleep: (ms) => new Promise(resolve => setTimeout(resolve, ms)),\n    loadMore: async (n = 1) => {\n      for(let i = 0; i < n; i++) {\n        console.log(`loading page ${i + 1}`);\n        await loadMore();\n        await shell.sleep(250);\n      }\n    },\n    select: (query) => {\n      console.log(selection);\n      let count = 0;\n      for(const message of $messages) {\n        if(matchMessage(query, message.get())) {\n          count++;\n          selection.add(message);\n        }\n      }\n      console.log(`selected ${count} messages`);\n    }   \n  }\n\n  const matchMessage = (query, message) => {\n    console.log(query, message, false);\n  \n    if(query.from) {\n      if(query.from instanceof RegExp) {\n        if(query.from.test(message.from.address || \"\") || query.from.test(message.from.name || \"\")) {\n          return true;\n        }\n      } else if((message.from.address || \"\").includes(query.from) || (message.from.name || \"\").includes(query.from)) {\n        return true;\n      }\n    }\n\n    if(query.subject) {\n      if(query.subject instanceof RegExp) {\n        if(query.subject.test(message.subject)) {\n          return true;\n        }\n      } else if(message.subject.includes(query.subject)) {\n        return true;\n      }\n    }\n\n    if(query.intro) {\n      if(query.intro instanceof RegExp) {\n        if(query.intro.test(message.intro)) {\n          return true;\n        }\n      } else if(message.intro.includes(query.intro)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  onMount(() => {\n    window.mailbox = shell;\n    return () => {\n      if(window.mailbox === shell) window.mailbox = null;\n    }\n  })\n\n  console.log($messages);\n</script>\n\n<style>\n  x-tab-content {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    overflow: auto;\n    padding-bottom: 3em;\n  }\n\n  x-mailbox-empty {\n    flex: none;\n    margin: 2em auto;\n    text-align: center;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    color: #333;\n    font-size: 1.1em;\n  }\n\n  .label {\n    font-weight: 500;\n    margin-top: 1em;\n  }\n\n  .select {\n    margin-inline-start: -0.15em;\n  }\n\n  .only-when-selection {\n    flex: 1;\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n  }\n\n  x-selection-info {\n    display: flex;\n    flex: none;\n    flex-direction: row-reverse;\n    align-items: center;\n    margin-inline-start: auto;\n    background: #c2dbff;\n    padding: 0.4em 0.5em;\n    border-radius: 100px;\n    color: #555;\n  }\n\n  x-selection-info > :global(svg) {\n    font-size: 1.1em;\n  }\n\n  x-selection-info > span {\n    font-size: 0.8em;\n    margin: 0 0.5em;\n  }\n\n  x-loadmore {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: var(--pc);\n    padding: 0.5em;\n    font-size: 2.5em;\n    min-height: auto;\n  }\n\n  x-loadmore-loading,\n  x-loadmore-button {\n    display: flex;\n    flex: none;\n    width: 1em;\n    height: 1em;\n    align-items: center;\n    justify-content: center;\n  }\n\n  x-loadmore-button {\n    cursor: pointer;\n    border-radius: 50%;\n  }\n\n  x-mailbox-message {\n    position: relative;\n    z-index: 2;\n    display: flex;\n    flex-direction: column;\n    flex: none;\n    justify-items: stretch;\n    align-items: stretch;\n    background: #fff;\n    transition: opacity 150ms ease, margin 150ms ease;\n  }\n\n  x-tab-content > :global(.removed) {\n    z-index: 1;\n    margin-block-end: -3.0625rem;\n    opacity: 0;\n  }\n</style>\n\n<svelte:head>\n  <title>{$mailbox.unseen ? `(${$mailbox.unseen}) ` : \"\"}{meta.label}</title>\n</svelte:head>\n\n<Tab>\n  <Topbar scrolled={$scroll !== 0}>\n    <x-action-group class=\"select\">\n      <x-action\n        class=\"btn-dark\"\n        data-tooltip={locale.actions.select}\n        on:click={handleSelection}\n      >\n        <Ripple />\n        {#if $selection.length === 0}\n          <CheckNone />\n        {:else if $selection.length === $messages.length}\n          <CheckAll />\n        {:else}\n          <CheckSome />\n        {/if}\n      </x-action>\n\n      <x-action\n        class=\"btn-dark reload\"\n        data-tooltip={locale.actions.reload}\n        on:click={reload}\n      >\n        <div\n          style=\"display: flex; transition: transform 300ms ease; transform: rotate({360 *\n            reloadTimes}deg)\"\n        >\n          <Refresh />\n        </div>\n        <Ripple />\n      </x-action>\n    </x-action-group>\n\n    {#if $selection.length !== 0}\n      <div\n        class=\"only-when-selection\"\n        transition:fade|local={{ duration: 150 }}\n      >\n        <x-action-group>\n          {#if $selection.every((m) => !m.get().seen)}\n            <x-action\n              class=\"btn-dark\"\n              data-tooltip={locale.actions.markAsRead}\n              on:click={() => updateSeen(true)}\n            >\n              <MarkSeen />\n              <Ripple />\n            </x-action>\n          {:else}\n            <x-action\n              class=\"btn-dark\"\n              data-tooltip={locale.actions.markAsUnread}\n              on:click={() => updateSeen(false)}\n            >\n              <MarkUnSeen />\n              <Ripple />\n            </x-action>\n          {/if}\n\n          {#if isJunk}\n            <x-action\n              class=\"btn-dark\"\n              data-tooltip={locale.actions.unMarkAsSpam}\n              on:click={() => markAsSpam(false)}\n            >\n              <UnMarkSpam />\n              <Ripple />\n            </x-action>\n          {:else if !isDraft && !isSent && !isTrash}\n            <x-action\n              class=\"btn-dark\"\n              data-tooltip={locale.actions.markAsSpam}\n              on:click={() => markAsSpam(true)}\n            >\n              <MarkSpam />\n              <Ripple />\n            </x-action>\n          {/if}\n\n          <x-action\n            class=\"btn-dark\"\n            data-tooltip={isTrash\n              ? locale.actions.deletePermanently\n              : isDraft\n              ? locale.actions.discardDrafts\n              : locale.actions.delete}\n            on:click={() => del()}\n          >\n            <Delete />\n            <Ripple />\n          </x-action>\n        </x-action-group>\n\n        <x-action-group>\n          <MoveTo {mailbox} {selection} on:moved={onSelectionMoved} />\n        </x-action-group>\n\n        <x-selection-info>\n          <Check />\n          <span>{$trans(\"selection.title\", { n: $selection.length })}</span>\n        </x-selection-info>\n      </div>\n    {/if}\n  </Topbar>\n\n  <x-tab-content on:scroll={(event) => ($scroll = event.target.scrollTop)}>\n    {#each $messages as message (`${$mailbox.id}-${message.get().id}`)}\n      <x-mailbox-message\n        out:flyRemove|local={{}}\n        in:flyInsert|local={{ duration: 150 }}\n      >\n        <Item {message} {mailbox} />\n      </x-mailbox-message>\n    {:else}\n      {#if !loadingMore}\n        <x-mailbox-empty>\n          <span class=\"label\">{locale.mailbox.empty}</span>\n        </x-mailbox-empty>\n      {/if}\n    {/each}\n\n    {#if loadingMore || $next}\n      <x-loadmore>\n        {#if loadingMore}\n          <x-loadmore-loading in:fade|local={{ delay: 150, duration: 150 }}>\n            <CircularProgress size=\"0.75em\" />\n          </x-loadmore-loading>\n        {:else if $next}\n          <x-loadmore-button\n            in:fade|local={{ delay: 150, duration: 150 }}\n            class=\"btn-dark\"\n            on:click={loadMore}\n          >\n            <More />\n            <Ripple />\n          </x-loadmore-button>\n        {/if}\n      </x-loadmore>\n    {/if}\n  </x-tab-content>\n</Tab>\n","<script context=\"module\">\n  import {user} from  \"../../client/client\";\n  import {get} from \"../../client/mailboxes\";\n  import {list} from \"../../client/messages\";\n  import {createSelection} from \"../../selection\";\n\n  export async function preload($page, {client}){\n    \n    if ( !user.get() ) {\n      return this.redirect(\"#!/login\");\n    }\n\n    const mailbox = get($page.params.mailbox);\n    if (mailbox == null ) {\n      return this.error({code: 404, message: \"La página no existe\"})\n    } else {\n      const json = await list($page.params.mailbox)\n      \n      const messages = writable(json.messages.map(m => writable(m)));\n      const next = writable(json.next);\n      const prev = writable(json.prev);\n      const selection = createSelection();\n      const scroll = writable(0);\n\n      return {mailbox, messages, prev, next, selection, scroll};\n    }\n  }\n</script>\n\n<script>\n  import {writable} from \"../../store\";\n  import Mailbox from \"../../../comp/Pages/Mailbox/Mailbox.svelte\";\n  \n  // stores;\n  export let mailbox \n  export let messages;\n  export let prev;\n  export let next;\n  export let selection;\n  export let scroll;\n</script>\n\n<Mailbox {mailbox} {messages} {prev} {next} {selection} {scroll} />","import { writable } from \"./store\";\nexport const createSelection = (items = []) => {\n    const selection = writable(items);\n    const clear = () => selection.set([]);\n    const add = (...args) => {\n        const helper = selection.get().slice();\n        for (const item of args) {\n            if (!helper.includes(item)) {\n                helper.push(item);\n            }\n            selection.set(helper);\n        }\n    };\n    const remove = (...args) => selection.update($selection => $selection.filter(i => !args.includes(i)));\n    const has = (item) => selection.get().includes(item);\n    const toggle = (item) => {\n        has(item) ? remove(item) : add(item);\n    };\n    const isSelected = writable(has);\n    selection.subscribe(isSelected.invalidate);\n    return { ...selection, clear, add, remove, toggle, isSelected };\n};\n"],"names":["ctx","size","width","height","color","viewBox","date","str","locale","now","Date","getFullYear","months","getMonth","getDate","weekDays","getDay","getHours","n","getMinutes","toString","padStart","from","name","address","mailboxMessage","to","map","filter","Boolean","join","subject","intro","flagged","id","seen","selection","getContext","isSelected","add","remove","toggle","message","isDraft","isSent","selected","mailbox","unsub","onDestroy","l","$l","drafts","sent","$isSelected","e","mess.flag","$mailbox","$message","update","m","preventDefault","$draft","mess.getDraft","draft","writable","subscribe","d","create","length","every","actions","deletePermanently","discardDrafts","delete","duration","markAsUnread","markAsRead","markAsSpam","unMarkAsSpam","select","reload","empty","delay","get","unseen","label","messages","next","prev","isJunk","isTrash","scroll","setContext","onSelectionMoved","ms","includes","clear","loadMore","updateSeen","$selection","forEach","invalidate","mess.updateSeen","i","mess.markAsSpam","value","del","mess.del","reloading","reloadTimes","loadingMore","$next","res","mess.next","set","trans","meta","shell","matchKeys","sleep","Promise","resolve","setTimeout","console","log","query","count","$messages","matchMessage","RegExp","test","onMount","window","junk","trash","mailboxMeta","title","$sel","slice","json","list","node","params","classList","style","zIndex","event","$scroll","target","scrollTop","preload","$page","client","user","this","redirect","error","code","items","args","helper","item","push","has","createSelection"],"mappings":"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"}