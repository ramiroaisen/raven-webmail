{"version":3,"file":"Message-ea0fcb10.js","sources":["../../node_modules/svelte-material-icons/ArrowLeft.svelte","../../src/comp/Attachments/Attachments.svelte","../../src/comp/Pages/Message/Message.svelte","../../src/lib/router/routes/Message.svelte"],"sourcesContent":["<script>\n  export let size = \"1em\";\n  export let width = size;\n  export let height = size;\n  export let color = \"currentColor\";\n  export let viewBox = \"0 0 24 24\";\n</script>\n\n<svg width=\"{width}\" height=\"{height}\" viewBox=\"{viewBox}\"><path d=\"M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z\" fill=\"{color}\"/></svg>","<style>\n  .anchor {\n    position: absolute;\n    left: 0;\n    bottom: 0;\n    font-size: 1rem;\n  }\n\n  x-count {\n    position: absolute;\n    top: 0;\n    right: 0;\n    font-size: 0.6em;\n    color: #fff;\n    background: var(--pc);\n    border-radius: 50%;\n    width: 1.4em;\n    height: 1.4em;\n    line-height: 1.4em;\n    text-align: center;\n  }\n\n  .item {\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    position: relative;\n  }\n\n  img {\n    flex: none;\n    height: 1.5em;\n    width: 1.5em;\n    margin-inline-end: 1em;\n    pointer-events: none;\n    position: absolute;\n    left: 0.5em;\n    top: calc(50% - 0.75em);\n  }\n</style>\n\n<script>\n  export let mailbox;\n  export let message;\n  export let attachments;\n\n  import Paperclip from \"svelte-material-icons/Paperclip.svelte\";\n  import {Ripple} from \"svelte-mui\";\n  import {url} from \"lib@fileIcons.js\";\n\n  import {getContext} from \"svelte\";\n  const {locale: l} = getContext(\"app\");\n  export let locale = $l;\n\n  import Popup from \"comp@Popup.svelte\";\n  import Menu from \"comp@Menu/Menu.svelte\";\n  import MenuItem from \"comp@Menu/MenuItem.svelte\";\n\n  export let menuOpen = false;\n  const toggle = () => menuOpen = !menuOpen;\n</script>\n\n  <x-action class=\"btn-dark\" class:hover={menuOpen} data-tooltip={locale.actions.attachments} on:click={toggle}>\n    <Paperclip/>\n    <Ripple/>\n    {#if attachments.length}\n      <x-count>{attachments.length}</x-count>\n    {/if}\n    <div class=\"anchor\">\n      <Popup anchor=\"top-left\" bind:open={menuOpen}>\n        <Menu>\n          {#each attachments as file}\n            <div class=\"item\">\n              <MenuItem href=\"/download/{$mailbox.id}/{$message.id}/{file.id}?filename={encodeURIComponent(file.filename)}\" target=\"_blank\">\n                {file.filename}\n              </MenuItem>\n              <img src={url(file.filename)} alt=\"\">\n            </div>\n          {/each}\n        </Menu>\n      </Popup>\n    </div>\n  </x-action>","<style>\n  x-tab-content {\n    position: relative;\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    overflow: auto;\n    padding: 2em 3em;\n  }\n\n  x-message-title {\n    font-size: 1.5em;\n    font-weight: 600;\n    min-height: auto;\n    word-break: break-word;\n  }\n\n  x-message-content {\n    margin-top: 3em;\n    min-height: auto;\n    margin-bottom: 2em;\n  }\n\n  x-message-content :global(a) {\n    color: blue;\n    text-decoration: underline;\n  }\n\n  x-message-content :global(a:visited) {\n    color: blueviolet;\n  }\n  \n  x-message-info {\n    flex: none;\n    display: flex;\n    flex-direction: column;\n    margin-top: 2em;\n  }\n\n  x-message-from, x-message-to, x-message-date {\n    padding: 0.25em 0;\n  }\n\n  x-message-content {\n    flex-grow: 1;\n  }\n\n  .from-main{\n    font-weight: 600;\n  }\n  \n</style>\n\n<script>\n  import {writable} from \"../../../lib/store\";\n  import {getContext} from \"svelte\";\n\n  import Tab from \"../Main.svelte\";\n  import Topbar from \"../ActionBar.svelte\";\n  //import Content from \"/comp/Tab/Content.svelte\";\n\n  import Delete from \"svelte-material-icons/DeleteOutline.svelte\";\n  import MarkUnseen from \"svelte-material-icons/EmailOutline.svelte\";\n  //import MarkSeen from \"svelte-material-icons/EmailOpenOutline.svelte\";\n  //import MarkUnseen from \"svelte-material-icons/EmailMultipleOutline.svelte\";\n  //import MarkUnseen from \"svelte-material-icons/EmailMarkAsUnread.svelte\";\n  import MarkSeen from \"svelte-material-icons/EmailOpenOutline.svelte\";\n  import MarkSpam from \"svelte-material-icons/AlertDecagramOutline.svelte\";\n  import UnMarkSpam from \"svelte-material-icons/EmailCheckOutline.svelte\";\n  import Resend from \"svelte-material-icons/EmailSendOutline.svelte\";\n  import Reply from \"svelte-material-icons/EmailReceiveOutline.svelte\";\n  import GoBack from \"svelte-material-icons/ArrowLeft.svelte\";\n\n  import {Ripple} from \"svelte-mui\";\n\n  import {sanitize} from \"../../../lib/sanitize\";\n\n  import {create} from \"../../Compose/compose\";\n  \n  export let mailbox;\n  export let message;\n  export let scroll;\n\n  const handleScroll = e => scroll.set(e.target.scrollTop);\n\n  import * as messages from \"../../../lib/client/messages\"\n  import * as mailboxes from \"../../../lib/client/mailboxes\"\n\n  let isJunk = mailboxes.junk === mailbox;\n  let isTrash = mailboxes.trash === mailbox;\n  let isDraft = mailboxes.drafts === mailbox;\n  let isSent = mailboxes.sent === mailbox;\n\n  const onetime = fn => {\n    let updating = false;\n    return async () => {\n      if (updating) return;\n      updating = true;\n      try {\n        await fn();\n      } catch(e) {\n        throw e;\n      } finally {\n        updating = false;\n      }\n    }\n  }\n\n  const seen = onetime(async () => {\n    await messages.updateSeen($mailbox.id, [$message.id], !$message.seen);\n    message.update(m => ({...m, seen: !m.seen}))\n  })\n\n  const spam = onetime(async () => {\n    await messages.markAsSpam($mailbox.id, [$message.id], !isJunk);\n    location.hash = `#!/mailbox/${$mailbox.id}`;\n  })\n\n  const del = onetime(async () => {\n    await messages.del($mailbox.id, [$message.id]);\n    location.hash = `#!/mailbox/${$mailbox.id}`;\n  })\n\n  const reply = onetime(async () => {\n    const $draft = await messages.createReply($mailbox.id, $message.id);\n    create(writable($draft));\n  })\n\n  const forward = onetime(async () => {\n    const $draft = await messages.createForward($mailbox.id, $message.id);\n    create(writable($draft));\n  })\n\n  import MoveTo from \"../MoveTo.svelte\";\n  const gotoBox = () => setTimeout((() => location.hash = `#!/mailbox/${$mailbox.id}`), 250);\n\n  import Attachments from \"comp@Attachments/Attachments.svelte\";\n\n  const {locale: l} = getContext(\"app\");\n  export let locale = $l;\n</script>\n\n<svelte:head>\n  <title>{$message.subject}</title>\n</svelte:head>\n\n<Tab>\n  <Topbar scrolled={$scroll !== 0}>\n    <x-action-group>\n      <a class=\"x-action btn-dark\" href=\"#!/mailbox/{$mailbox.id}\" data-tooltip={locale.actions.backToMailbox}>\n        <GoBack />\n        <Ripple />\n      </a>\n    </x-action-group>\n\n    <x-action-group>\n      <x-action \n        class=\"btn-dark\"\n        data-tooltip={$message.seen ? locale.actions.markAsUnread : locale.actions.markAsRead}\n        on:click={seen}\n      >\n        <Ripple />\n        {#if $message.seen}\n          <MarkUnseen />\n        {:else}\n          <MarkSeen />\n        {/if}\n      </x-action>\n\n      {#if isJunk}\n        <x-action class=\"btn-dark\" data-tooltip={locale.actions.unMarkAsSpam} on:click={spam}>\n          <UnMarkSpam />\n          <Ripple />\n        </x-action>\n      {:else if !isDraft && !isSent && !isTrash}\n        <x-action class=\"btn-dark\" data-tooltip={locale.actions.markAsSpam} on:click={spam}>\n          <MarkSpam />\n          <Ripple />\n        </x-action>\n      {/if}\n\n      <x-action class=\"btn-dark\" data-tooltip={\n          isTrash ? locale.actions.deletePermanently :\n          isDraft ? locale.actions.discardDrafts :\n          locale.actions.delete\n      } on:click={del}>\n        <Delete />\n        <Ripple />\n      </x-action>\n    </x-action-group>\n\n    <x-action-group>\n      <x-action class=\"btn-dark\" data-tooltip={locale.actions.forward} on:click={forward}>\n        <Resend />\n        <Ripple />\n      </x-action>\n\n      {#if !isDraft && !isSent}\n        <x-action class=\"btn-dark\" data-tooltip={locale.actions.reply} on:click={reply}>\n          <Reply />\n          <Ripple />\n        </x-action>\n      {/if}\n    </x-action-group>\n\n    <x-action-group>\n      <MoveTo {mailbox} selection={writable([message])} on:moved={gotoBox} tooltip={locale.actions.moveTo} />\n    </x-action-group>\n\n    {#if $message.attachments && $message.attachments.length}\n      <x-action-group>\n        <Attachments {mailbox} {message} attachments={$message.attachments} tooltip={locale.actions.attachments} />\n      </x-action-group>\n    {/if}\n  </Topbar>\n\n  <x-tab-content on:scroll={handleScroll}>\n    <x-message-title>{$message.subject}</x-message-title>\n    <x-message-info>\n\n      {#if $message.from}\n        <x-message-from>       \n          {#if $message.from.name}\n            {locale.message.labels.from}\n            <span class=\"from-main\">{$message.from.name}</span>\n            {\"<\"}{$message.from.address}{\">\"}\n          {:else}\n            {locale.message.labels.from}\n            <span class=\"from-main\">\n              {$message.from.address} \n            </span>\n          {/if}\n        </x-message-from>\n      {/if}\n      \n      {#if $message.to}\n        <x-message-to>\n          {locale.message.labels.to} {$message.to.map(to => {\n              return `<${to.address}>`\n            }).join(\", \")}\n        </x-message-to>\n      {/if}\n      \n      {#if $message.date}\n        <x-message-date>\n          {locale.message.labels.date} {new Date($message.date).toLocaleString()}\n        </x-message-date>\n      {/if}\n    </x-message-info>\n\n    <x-message-content>\n      {#if $message.html && $message.html.length}\n        {@html sanitize($message.html.join(\"\"))}\n      {:else if $message.text && $message.text.trim()}\n        <pre>{$message.text}</pre>\n      {/if}\n    </x-message-content>\n\n  </x-tab-content>\n</Tab>","<script context=\"module\">\n  import {writable} from \"../../../lib/store\";\n  import {user} from \"../../../lib/client/client\";\n  import * as mailboxes from \"../../../lib/client/mailboxes\";\n  import * as messages from \"../../../lib/client/messages\";\n\n  export async function preload($page) {\n    \n    if ( !user.get() ) {\n      return this.redirect(\"#!/login\");\n    }\n\n    const mailbox = await mailboxes.get($page.params.mailbox);\n    \n    if (mailbox == null) {\n      return this.redirect(\"#!/\");\n    }\n\n    try {\n      const $message = await messages.get($page.params.mailbox, $page.params.message);\n      const message = writable($message);\n      const scroll = writable(0);\n      return { mailbox, message, scroll };\n\n    } catch(e) {\n      this.redirect(`#!/mailbox/${mailbox.get().id}`);\n    }\n  }\n</script>\n\n<script>\n  import Message from \"../../../comp/Pages/Message/Message.svelte\";\n  //import Page from \"../../comp/Page.svelte\";\n\n  export let mailbox;\n  export let message;\n  export let scroll;\n</script>\n\n<Message {mailbox} {message} {scroll} />"],"names":["ctx","size","width","height","color","viewBox","length","filename","id","encodeURIComponent","url","actions","attachments","mailbox","message","locale","l","getContext","$l","menuOpen","markAsSpam","unMarkAsSpam","seen","reply","writable","moveTo","backToMailbox","markAsUnread","markAsRead","deletePermanently","discardDrafts","delete","forward","from","name","labels","address","to","map","join","date","Date","toLocaleString","text","sanitize","html","subject","trim","scroll","isJunk","mailboxes.junk","isTrash","mailboxes.trash","isDraft","mailboxes.drafts","isSent","mailboxes.sent","onetime","fn","updating","e","messages.updateSeen","$mailbox","$message","update","m","spam","messages.markAsSpam","location","hash","del","messages.del","$draft","messages.createReply","create","messages.createForward","set","target","scrollTop","setTimeout","preload","$page","user","get","this","redirect","mailboxes.get","params","messages.get"],"mappings":"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"}